- name: Validar com Gemini 2.0 Flash (JSON estrito)
  id: gemini
  env:
    GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  run: |
    # 1) Defina o schema de saída (obriga o JSON) — sem usar read -d ''
    SCHEMA=$(cat <<'JSON'
    {
      "type": "object",
      "properties": {
        "aprovado": { "type": "boolean" },
        "motivos":  { "type": "array", "items": { "type": "string" } },
        "titulo_corrigido": { "type": ["string", "null"] },
        "observacoes": { "type": ["string", "null"] }
      },
      "required": ["aprovado", "motivos"],
      "additionalProperties": false
    }
    JSON
    )

    # 2) System instruction
    SYS=$(cat <<'TXT'
    Você é um revisor de qualidade de bugs.
    Aprove apenas se T-O-D-O-S os campos obrigatórios estiverem informativos:
    - Descrição do Bug (contexto/impacto)
    - Localização (caminho/tela)
    - Passos para Reprodução (passo a passo claro)
    - Evidências (link de print/vídeo)
    - Resultado Esperado (comportamento correto)
    Responda SOMENTE no schema JSON definido.
    TXT
    )

    # 3) Prompt com os dados do formulário
    USER=$(cat <<'TXT'
    Descrição do Bug:
    ${{ steps.parse.outputs.descricao }}

    Localização:
    ${{ steps.parse.outputs.localizacao }}

    Passos para Reprodução:
    ${{ steps.parse.outputs.passos }}

    Evidências:
    ${{ steps.parse.outputs.evidencias }}

    Resultado Esperado:
    ${{ steps.parse.outputs.resultado }}
    TXT
    )

    # 4) Monta o payload do Gemini API
    PAYLOAD=$(jq -n \
      --arg sys "$SYS" \
      --arg user "$USER" \
      --argjson schema "$SCHEMA" \
      '{
        system_instruction: { text: $sys },
        contents: [{ role: "user", parts: [{text: $user}]}],
        generationConfig: {
          response_mime_type: "application/json",
          response_schema: $schema,
          temperature: 0.2
        }
      }'
    )

    # 5) Chama o endpoint e captura HTTP code para debug
    HTTP=$(curl -sS -w "%{http_code}" -o resp.json \
      -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent" \
      -H "Content-Type: application/json" \
      -H "x-goog-api-key: $GOOGLE_API_KEY" \
      -d "$PAYLOAD")

    echo "HTTP status: $HTTP"
    if [ "$HTTP" -lt 200 ] || [ "$HTTP" -ge 300 ]; then
      echo "Resposta da API (erro):"
      cat resp.json
      exit 1
    fi

    # 6) Extrai o JSON retornado
    TEXT=$(jq -r '.candidates[0].content.parts[0].text // empty' resp.json)
    if [ -z "$TEXT" ]; then
      echo "Resposta sem conteúdo de texto esperado:"
      cat resp.json
      exit 1
    fi

    # Valida que é JSON válido
    echo "$TEXT" | jq . > gemini.json || {
      echo "O modelo não retornou JSON válido conforme schema:"
      echo "$TEXT"
      exit 1
    }

    APROVADO=$(jq -r '.aprovado' gemini.json)
    TITULO_CORRIGIDO=$(jq -r '.titulo_corrigido' gemini.json)

    echo "aprovado=$APROVADO" >> $GITHUB_OUTPUT
    echo "titulo_ok=$TITULO_CORRIGIDO" >> $GITHUB_OUTPUT
